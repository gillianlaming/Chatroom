<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8"/>
      <title>chatroom</title>
      <script src="/socket.io/socket.io.js"></script>
      <link rel="stylesheet" href="../chat.css">
    </head>

    <body>
      <div id="getUsername">
          <h1>welcome to our chatroom!</h1>
          <h3>enter a nickname to enter</h3>
          <input type="text" id="username"/>
          <button onclick="sendUsername()">enter</button>
      </div>
      <div id="theChatroom">
      <br><br>
        <div class="column left_column" id="left">
            <button id="leave_room" onclick="leaveRoom()">leave this room</button>
          <div id="rooms_header">
            <h3>rooms:</h3>
            <p>(click to visit)</p>
          </div>
          <ul class="list" id="rooms_list">
             <!-- should load in room names -->
          </ul>

          <div id="new_room_stuff">
            <hr width="50%" style="margin-left: 0">
            <input type="text" id="room_name"/>
            <button onclick="addRoom()" id="add_room">add a room</button><br>
            <input type="checkbox" id="private">private room
          </div>
        </div>
        
        <div class="column middle_column" id="middle">
          <h1>room <i id="room_title"></i></h1><!-- when room is selected, append room name to this -->
          <div id="chatlog"></div><!-- should load in previous messages in this room  -->
          <div id="messenger"> 
            <input type="text" id="message_input"/>
            <button onclick="sendMessage()">send message</button>
          </div>
        </div>
        <div class="column right_column" id="right">
          <h3>users in this room:</h3>
          <p>(click to kick out or ban)</p>
            <ul class="list" id="users_list">
                 <!-- should add username once user joins room. also must broadcast change -->
            </ul>
        </div>
      </div>
   </body>

   <script>
     var loggedIn; 
     var nickname;
     var roomName;

      var socketio = io.connect();
      window.addEventListener("unload", function(){ // handles case when user leaves page || reloads page
        console.log("testing")
        roomName = document.getElementById("room_title").textContent;
        if ((loggedIn == "true") && (roomName != "null")){ //if the user is in a room
          socketio.emit("remove_user_from_room");
          leaveRoom();
          socketio.emit("users_in_room", roomName); //display all of the current users in the room
        }
      });
      // DISPLAYS ROOM NAMES AS BUTTONS
      socketio.on("room_names", function(roomName){
        var btn = document.getElementById("rooms_list").appendChild(document.createElement("button")); //add a button for every room
        btn.appendChild(document.createTextNode(roomName));
        document.getElementById("rooms_list").appendChild(document.createElement("br"));

        // FUNCTION FOR ENTERING A ROOM 
        btn.onclick = function(){ 
          document.getElementById("chatlog").innerHTML = ""; // clear previous chat
          socketio.emit("users_in_room", roomName); //display all of the current users in the room
          socketio.emit("add_user_to_room", roomName); //add current user to room in sql
          socketio.emit("messages_in_room", roomName); //display all the old messages when the user enters
          loggedIn = "true";
          document.getElementById('leave_room').style.visibility = "visible"; // display leave room btn
          document.getElementById("rooms_header").style.visibility="hidden"; // hide header
          document.getElementById("rooms_list").style.visibility="hidden"; // hide room list 
          document.getElementById("new_room_stuff").style.visibility = "hidden"; //can't add a new room when you're still in a room
          
          document.getElementById("middle").style.visibility = "visible"; // show chatroom
          document.getElementById("right").style.visibility = "visible"; // show users list

          document.getElementById("room_title").innerHTML = roomName; // show name
        }
      });

      // Display all the users in a room
      socketio.on("display_users", function(username){
          var usrbtn = document.getElementById("users_list").appendChild(document.createElement("button"));
          usrbtn.appendChild(document.createTextNode(username + " "));
          document.getElementById("users_list").appendChild(document.createElement("br"));
          usrbtn.onclick = function(){
            userOptions() //will be able to block an ban users, report users
          };
      });
      
      // Display all the messages in a room
      socketio.on("display_message", function(data){
          // get messages and append to chatlog  
          var name = data['username']; var mess = data['message']; var time = data['timestamp'];  
                // idk if timestamp is required, wouldnt be too hard to display, but if not required lets not
          document.getElementById("chatlog").appendChild(document.createTextNode(name + ": "));
          document.getElementById("chatlog").appendChild(document.createTextNode(mess));
          document.getElementById("chatlog").appendChild(document.createElement('br'));
          document.getElementById("chatlog").appendChild(document.createElement('br'));
      });
      socketio.on("display_user", function(username){
        document.getElementById("rooms_header").appendChild(document.createTextNode("Hello, " + username));
      });

      socketio.on("remove_user", function(username){  //remove username button
        console.log("trying to remove user " + username);
        var len = document.getElementById("users_list").childElementCount;
        for (var i = 0; i<len; ++i){
          if (document.getElementById('users_list')[i].textContent == "username"){
            //do something
          }
        }
        document.getElementById("users_list").style.display = "none";
        socketio.emit("users_in_room", roomName);
        document.getElementById("users_list").style.display = "block";
        //var len = document.getElementById("users_list").childElementCount;
        //for ()
      });

      //banning a user and kicking a user out
      function userOptions(){
        console.log("user options")  
      }

      // LEAVE ROOM
      function leaveRoom(){ 
            document.getElementById("room_title").innerHTML = ""; // delete name

            document.getElementById("leave_room").style.visibility = "hidden";  // hide leave room button
            document.getElementById("rooms_header").style.visibility = "visible";// show rooms header and rooms list
            document.getElementById("rooms_list").style.visibility = "visible";
            document.getElementById("new_room_stuff").style.visibility = "visible"; // show add room button
            document.getElementById("middle").style.visibility = "hidden"; 
            document.getElementById("right").style.visibility = "hidden"; // hide middle and right column 

            document.getElementById("users_list").innerHTML = ""; // remove all users from list ISSUE

            socketio.emit("remove_user_from_room"); //remove room attribute from user
      }

      // LOG IN
      function sendUsername(){
        var username = document.getElementById("username").value; //get the entered value of the username
        document.getElementById("getUsername").style.visibility = "hidden";
        document.getElementById("left").style.visibility = "visible"; // only left is visible, middle and right become visble when we enter a room
        document.getElementById("username").value = ""; // reset form

        socketio.emit('little_newbie', username); //send the username to server
      }

      // NEW ROOM
      function addRoom(){
          var roomName = document.getElementById("room_name").value;
          var isChecked = document.getElementById("private").checked;
          if(isChecked){
            //password popup
            //capture password
          }
          document.getElementById("room_name").value = ""; //reset form

          socketio.emit('get_room_name', roomName); //send roomname to server so it can add to sql
      }

      // SEND A MESSAGE
      function sendMessage(){
         var msg = document.getElementById("message_input").value;
         var room = document.getElementById("room_title").textContent;
         document.getElementById("message_input").value = ""; // reset form

         socketio.emit("message_to_server", {message:msg, roomName:room}); // send message and username to sql
      }

    </script>
</html>